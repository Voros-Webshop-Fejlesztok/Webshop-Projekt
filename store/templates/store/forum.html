{% extends 'store/main.html' %}
{% load static %}
{% block content %}

{% for message in messages %}
<div style="display: block;" class="popup" id="popup">
    {% if message|striptags == 'A bejegyzés címe legfeljebb 50 karakter a tartalma pedig legfeljebb 1000 karakter lehet' %}
    <img src="{% static 'images/x.png' %}" />
    {% else %}
    <img src="{% static 'images/tick.png' %}" />
    {% endif %}
    <div style="margin-top: 20px;" class="message {{ message.tags }}">{{message}}</div>
    <br>
        {% if message|striptags == 'A bejegyzés címe legfeljebb 50 karakter a tartalma pedig legfeljebb 1000 karakter lehet' %}
        <button style="background: red;" id="popupClose">OK</button>
        {% else %}
        <button id="popupClose">OK</button>
        {% endif %}
</div>
{% endfor %}

{% if form %}
<form id="post" method=POST>
    {% csrf_token %}

    <div class="wrapper">
      <div class="card2">
        <div class="user">
          <div class="profile">
            <div class="row">
            <div class="col-md-12 col-lg-2">
            {% if self_profile.imageURL %}
              <img src="{{self_profile.imageURL}}" class="ava">
            {% else %}
              <img src="{% static 'images/placeholder_img.jpg' %}" class="ava">
            {% endif %}
            </div> 
            <div style="margin-left: 10px;" class="username col-md-12 col-lg-7">
              <h3 class="uname">{{self_profile.user}}</h3>
              
              <p style="margin: 0;" class="name">{{form.title}}</p>
            </div>
            </div>
          </div>
        </div>
        <div class="twitt">
          <p style="margin: auto;">{{form.body}}</p>
        </div>
        <button class="button-33 post">Közlés</button>
      </div>
    </div>
</form>
{% endif %}


{% for post in posts %}
<div class="wrapper">
    <div class="card2">
      <div class="user">
        <div class="profile">
          <a href="{% url 'profile' post.profile.user.id %}">
            {% if post.profile.imageURL %}
                <img src="{{post.profile.imageURL}}" class="ava">
            {% else %}
                <img src="{% static 'images/placeholder_img.jpg' %}" class="ava">
            {% endif %} 
          </a>
          <div class="username">
            <a href="{% url 'profile' post.profile.user.id %}"><h3 class="uname">{{post.profile.user}}</h3></a>
            <p class="name">{{post.title}}</p>
          </div>
        </div>        
      </div>
      <div class="twitt">
        <p>{{post.body}}</p>
      </div>
      <div class="insight">
        <div class="like">
          <a href="{% url 'post_like' post.id %}">
          <svg width="24" height="24" viewBox="0 0 24 24" {% if self_profile in post.likes.all %}fill="red"{% else %}fill="none"{% endif %} xmlns="http://www.w3.org/2000/svg">
            <g id="heart">
              <path id="Vector" d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.57831 8.50903 2.99871 7.05 2.99871C5.59096 2.99871 4.19169 3.57831 3.16 4.61C2.1283 5.64169 1.54871 7.04097 1.54871 8.5C1.54871 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6054C22.3095 9.93789 22.4518 9.22249 22.4518 8.5C22.4518 7.77751 22.3095 7.0621 22.0329 6.39464C21.7563 5.72718 21.351 5.12075 20.84 4.61V4.61Z" stroke="white" stroke-opacity="0.6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </g>
          </svg>
          </a>
          {% if post.likes.all.count == 1 %}
          {% if post.likes.all.0.user == request.user %}
          <p class="like-value"><strong>Kedveled</strong> a bejegyzést</p>
          {% else %}
          <p class="like-value"><a class="liker" href="{% url 'profile' post.likes.all.0.user.id %}">{{post.likes.all.0.user}}</a> kedveli a bejegyzést</p>
          {% endif %} 
          {% endif %}
          {% if post.likes.all.count > 1 %}
          {% if post.likes.all.0.user == request.user %}
          <p class="like-value"><strong>Kedveled</strong> és rajtad kívül további <span data-target="{{post.id}}" id="showLikes" class="likes">{{post.number_of_likes}} személy </span>kedveli a bejegyzést</p>
          {% else %} 
          <p class="like-value"><a class="liker" href="{% url 'profile' post.likes.all.0.user.id %}">{{post.likes.all.0.user}}</a> és további <span data-target="{{post.id}}" id="showLikes" class="likes">{{post.number_of_likes}} személy</span> kedveli a bejegyzést</p>
          {% endif %} 
          {% endif %} 
        </div>
        </div>
      <div class="created">
        <p>{{post.created|date:'Y.m.d - H:i'}}</p>
      </div>
    </div>
  </div>


  <div style="display: block;" class="popup hidden" id="likes{{post.id}}">
    <i id="closeLikes" data-target="{{post.id}}" style="font-size: 25px; float: right; margin-top: 20px; cursor: pointer;" class='bx bxs-x-circle'></i>
    <div style="margin-top: 10px;">
    <p ><strong>Összesen {{post.likes.all.count}} kedvelés van a bejegyzésen</strong></p><hr>
    {% for liker in post.likes.all %}
        <div style="margin: 10px;">
        {% if liker.imageURL %}
        <img src="{{liker.imageURL}}" style="width: 20px; height: 20px; margin: auto;">
        {% else %}
        <img src="{% static 'images/placeholder_img.jpg' %}" style="width: 20px; height: 20px; margin: auto;">
        {% endif %}
        <a class="liker" href="{% url 'profile' liker.user.id %}">{{liker.user}}</a>
        </div>
    {% endfor %} 
    </div>
</div>



{% endfor %}

{% if messages %}
<script>
    popup = document.getElementById('popup');

    popup.style.display = 'block';

    setTimeout(loginAnimation, 6000);

    function loginAnimation() {
        document.getElementById('popup').style.animation = "closePopupAnimation 0.5s ease-in-out";

        setTimeout(function() {
            document.getElementById('popup').style.animation = "";
            document.getElementById('popup').style.display = "none";
        }, 500);  
    }

    var popupClose = document.getElementById('popupClose')
    popupClose.addEventListener("click", function () {
        loginAnimation()
      });

</script>
{% endif %}


<script>
  const showLikesElements = document.querySelectorAll('#showLikes');
  const closeLikesElements = document.querySelectorAll('#closeLikes');

  showLikesElements.forEach(spanElement => {
            spanElement.addEventListener('click', function() {
                handleSpanClick(this);
            });
        });

        function handleSpanClick(spanElement) {
            // Az adott span elemhez tartozó data-target érték lekérdezése
            const dataTargetValue = spanElement.getAttribute('data-target');

            const divId = `likes${dataTargetValue}`;
            const targetDiv = document.getElementById(divId)

            targetDiv.classList.remove('hidden')
            
        }

  closeLikesElements.forEach(spanElement => {
            spanElement.addEventListener('click', function() {
                handleCloseClick(this);
            });
        });

        function handleCloseClick(spanElement) {
            // Az adott span elemhez tartozó data-target érték lekérdezése
            const dataTargetValue = spanElement.getAttribute('data-target');

            const divId = `likes${dataTargetValue}`;
            const targetDiv = document.getElementById(divId)

            targetDiv.classList.add('hidden')   
        }
</script>

{% endblock content %}

